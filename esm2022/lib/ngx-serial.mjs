export class NgxSerial {
    port;
    options = { baudRate: 9600, dataBits: 8, parity: 'none', bufferSize: 256, flowControl: 'none' }; //Default
    writer;
    readFunction;
    controlCharacter = "\n";
    reader;
    readableStreamClosed;
    writableStreamClosed;
    keepReading = true;
    constructor(readFunction, options, controlCharacter) {
        this.readFunction = readFunction;
        if (options)
            this.options = options;
        if (controlCharacter)
            this.controlCharacter = controlCharacter;
    }
    async sendData(data) {
        await this.writer.write(data);
    }
    async readLoop() {
        while (this.port.readable && this.keepReading) {
            const textDecoder = new TextDecoderStream();
            this.readableStreamClosed = this.port.readable.pipeTo(textDecoder.writable);
            this.reader = this.port.readable //textDecoder.readable
                //.pipeThrough(new TransformStream(new LineBreakTransformer(this.controlCharacter)))
                .getReader();
            try {
                while (true) {
                    const { value, done } = await this.reader.read();
                    if (done) {
                        break;
                    }
                    if (value) {
                        this.readFunction(value);
                    }
                }
            }
            catch (error) {
                console.error("Read Loop error. Have the serial device been disconnected ? ");
            }
        }
    }
    async close(callback) {
        this.keepReading = false;
        this.reader.cancel();
        await this.readableStreamClosed.catch(() => { });
        this.writer.close();
        await this.writableStreamClosed;
        await this.port.close();
        callback(null);
    }
    async connect(callback) {
        this.keepReading = true;
        if ("serial" in navigator) {
            // The Web Serial API is supported by the browser.
            let nav = navigator;
            const ports = await nav.serial.getPorts();
            try {
                this.port = await nav.serial.requestPort();
            }
            catch (error) {
                console.error("Requesting port error: " + error);
                return;
            }
            try {
                await this.port.open(this.options);
            }
            catch (error) {
                console.error("Opening port error: " + error);
                return;
            }
            const textEncoder = new TextEncoderStream();
            this.writableStreamClosed = textEncoder.readable.pipeTo(this.port.writable);
            this.writer = textEncoder.writable.getWriter();
            this.readLoop();
            callback(this.port);
        }
        else {
            console.error("This browser does NOT support the Web Serial API");
        }
    }
}
class LineBreakTransformer {
    container = "";
    controlCharacter;
    constructor(controlCharacter) {
        this.container = '';
        this.controlCharacter = controlCharacter;
    }
    transform(chunk, controller) {
        this.container += chunk;
        const lines = this.container.split(this.controlCharacter);
        this.container = lines.pop();
        lines.forEach((line) => controller.enqueue(line));
    }
    flush(controller) {
        controller.enqueue(this.container);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXNlcmlhbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1zZXJpYWwvc3JjL2xpYi9uZ3gtc2VyaWFsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE1BQU0sT0FBTyxTQUFTO0lBRVYsSUFBSSxDQUFNO0lBQ1YsT0FBTyxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxTQUFTO0lBQzFHLE1BQU0sQ0FBTTtJQUNaLFlBQVksQ0FBVztJQUN2QixnQkFBZ0IsR0FBVyxJQUFJLENBQUM7SUFDaEMsTUFBTSxDQUFLO0lBQ1gsb0JBQW9CLENBQUs7SUFDekIsb0JBQW9CLENBQUs7SUFDekIsV0FBVyxHQUFXLElBQUksQ0FBQztJQUVuQyxZQUFZLFlBQXNCLEVBQUUsT0FBYSxFQUFFLGdCQUFzQjtRQUN2RSxJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLE9BQU87WUFDVCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN6QixJQUFJLGdCQUFnQjtZQUNsQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7SUFFN0MsQ0FBQztJQUNNLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBWTtRQUNoQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFTyxLQUFLLENBQUMsUUFBUTtRQUdwQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUcsQ0FBQztZQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLGlCQUFpQixFQUFFLENBQUM7WUFDNUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElB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QUNwRSxDQUFDO0lBRUgsQ0FBQztDQUNGO0FBRUQsTUFBTSxvQkFBb0I7SUFDeEIsU0FBUyxHQUFNLEVBQUUsQ0FBQztJQUNWLGdCQUFnQixDQUFTO0lBRWpDLFlBQVksZ0JBQXdCO1FBQ2xDLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQTtJQUMxQyxDQUFDO0lBRUQsU0FBUyxDQUFDLEtBQVMsRUFBRSxVQUFjO1FBQ2pDLElBQUksQ0FBQyxTQUFTLElBQUksS0FBSyxDQUFDO1FBQ3hCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzFELElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzdCLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQWM7UUFDbEIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDckMsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTk9ORV9UWVBFIH0gZnJvbSBcIkBhbmd1bGFyL2NvbXBpbGVyXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgTmd4U2VyaWFsIHtcclxuXHJcbiAgICBwcml2YXRlIHBvcnQ6IGFueTtcclxuICAgIHByaXZhdGUgb3B0aW9ucyA9IHsgYmF1ZFJhdGU6IDk2MDAsIGRhdGFCaXRzOiA4LCBwYXJpdHk6ICdub25lJywgYnVmZmVyU2l6ZTogMjU2LCBmbG93Q29udHJvbDogJ25vbmUnIH07IC8vRGVmYXVsdFxyXG4gICAgcHJpdmF0ZSB3cml0ZXI6IGFueTtcclxuICAgIHByaXZhdGUgcmVhZEZ1bmN0aW9uOiBGdW5jdGlvbjtcclxuICAgIHByaXZhdGUgY29udHJvbENoYXJhY3Rlcjogc3RyaW5nID0gXCJcXG5cIjtcclxuICAgIHByaXZhdGUgcmVhZGVyOmFueTtcclxuICAgIHByaXZhdGUgcmVhZGFibGVTdHJlYW1DbG9zZWQ6YW55O1xyXG4gICAgcHJpdmF0ZSB3cml0YWJsZVN0cmVhbUNsb3NlZDphbnk7XHJcbiAgICBwcml2YXRlIGtlZXBSZWFkaW5nOmJvb2xlYW4gPSB0cnVlO1xyXG4gIFxyXG4gICAgY29uc3RydWN0b3IocmVhZEZ1bmN0aW9uOiBGdW5jdGlvbiwgb3B0aW9ucz86IGFueSwgY29udHJvbENoYXJhY3Rlcj86IGFueSkge1xyXG4gICAgICB0aGlzLnJlYWRGdW5jdGlvbiA9IHJlYWRGdW5jdGlvbjtcclxuICAgICAgaWYgKG9wdGlvbnMpXHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcclxuICAgICAgaWYgKGNvbnRyb2xDaGFyYWN0ZXIpXHJcbiAgICAgICAgdGhpcy5jb250cm9sQ2hhcmFjdGVyID0gY29udHJvbENoYXJhY3RlcjtcclxuICBcclxuICAgIH1cclxuICAgIHB1YmxpYyBhc3luYyBzZW5kRGF0YShkYXRhOiBzdHJpbmcpIHtcclxuICAgICAgYXdhaXQgdGhpcy53cml0ZXIud3JpdGUoZGF0YSk7XHJcbiAgICB9XHJcbiAgXHJcbiAgICBwcml2YXRlIGFzeW5jIHJlYWRMb29wKCkge1xyXG4gICAgICBcclxuICBcclxuICAgICAgd2hpbGUgKHRoaXMucG9ydC5yZWFkYWJsZSAmJiB0aGlzLmtlZXBSZWFkaW5nICkge1xyXG4gICAgICAgIGNvbnN0IHRleHREZWNvZGVyID0gbmV3IFRleHREZWNvZGVyU3RyZWFtKCk7XHJcbiAgICAgICAgdGhpcy5yZWFkYWJsZVN0cmVhbUNsb3NlZCA9IHRoaXMucG9ydC5yZWFkYWJsZS5waXBlVG8odGV4dERlY29kZXIud3JpdGFibGUpO1xyXG4gICAgICAgIHRoaXMucmVhZGVyID0gdGhpcy5wb3J0LnJlYWRhYmxlIC8vdGV4dERlY29kZXIucmVhZGFibGVcclxuICAgICAgICAgIC8vLnBpcGVUaHJvdWdoKG5ldyBUcmFuc2Zvcm1TdHJlYW0obmV3IExpbmVCcmVha1RyYW5zZm9ybWVyKHRoaXMuY29udHJvbENoYXJhY3RlcikpKVxyXG4gICAgICAgICAgLmdldFJlYWRlcigpO1xyXG4gIFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICB3aGlsZSAodHJ1ZSkge1xyXG4gICAgICAgICAgICBjb25zdCB7IHZhbHVlLCBkb25lIH0gPSBhd2FpdCB0aGlzLnJlYWRlci5yZWFkKCk7XHJcbiAgICAgICAgICAgIGlmIChkb25lKSB7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5yZWFkRnVuY3Rpb24odmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJSZWFkIExvb3AgZXJyb3IuIEhhdmUgdGhlIHNlcmlhbCBkZXZpY2UgYmVlbiBkaXNjb25uZWN0ZWQgPyBcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgYXN5bmMgY2xvc2UoY2FsbGJhY2s6RnVuY3Rpb24pIHtcclxuICAgICAgdGhpcy5rZWVwUmVhZGluZyA9IGZhbHNlO1xyXG4gICAgICB0aGlzLnJlYWRlci5jYW5jZWwoKTtcclxuICAgICAgYXdhaXQgdGhpcy5yZWFkYWJsZVN0cmVhbUNsb3NlZC5jYXRjaCgoKSA9PiB7fSk7XHJcbiAgICAgIHRoaXMud3JpdGVyLmNsb3NlKCk7XHJcbiAgICAgIGF3YWl0IHRoaXMud3JpdGFibGVTdHJlYW1DbG9zZWQ7XHJcbiAgICAgIGF3YWl0IHRoaXMucG9ydC5jbG9zZSgpO1xyXG4gICAgICBjYWxsYmFjayhudWxsKTtcclxuICAgIH1cclxuICBcclxuICAgIHB1YmxpYyBhc3luYyBjb25uZWN0KGNhbGxiYWNrOkZ1bmN0aW9uKSB7XHJcbiAgICAgIHRoaXMua2VlcFJlYWRpbmcgPSB0cnVlO1xyXG4gICAgICBpZiAoXCJzZXJpYWxcIiBpbiBuYXZpZ2F0b3IpIHtcclxuICAgICAgICAvLyBUaGUgV2ViIFNlcmlhbCBBUEkgaXMgc3VwcG9ydGVkIGJ5IHRoZSBicm93c2VyLlxyXG4gICAgICAgIGxldCBuYXY6IGFueSA9IG5hdmlnYXRvcjtcclxuICAgICAgICBjb25zdCBwb3J0cyA9IGF3YWl0IG5hdi5zZXJpYWwuZ2V0UG9ydHMoKTtcclxuICBcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgdGhpcy5wb3J0ID0gYXdhaXQgbmF2LnNlcmlhbC5yZXF1ZXN0UG9ydCgpO1xyXG4gIFxyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKFwiUmVxdWVzdGluZyBwb3J0IGVycm9yOiBcIiArIGVycm9yKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgYXdhaXQgdGhpcy5wb3J0Lm9wZW4odGhpcy5vcHRpb25zKTtcclxuICBcclxuICBcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcihcIk9wZW5pbmcgcG9ydCBlcnJvcjogXCIgKyBlcnJvcik7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gIFxyXG4gICAgICAgIGNvbnN0IHRleHRFbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyU3RyZWFtKCk7XHJcbiAgICAgICAgdGhpcy53cml0YWJsZVN0cmVhbUNsb3NlZCA9IHRleHRFbmNvZGVyLnJlYWRhYmxlLnBpcGVUbyh0aGlzLnBvcnQud3JpdGFibGUpO1xyXG4gICAgICAgIHRoaXMud3JpdGVyID0gdGV4dEVuY29kZXIud3JpdGFibGUuZ2V0V3JpdGVyKCk7XHJcbiAgXHJcbiAgICAgICAgdGhpcy5yZWFkTG9vcCgpO1xyXG4gIFxyXG4gICAgICAgIGNhbGxiYWNrKHRoaXMucG9ydCk7XHJcbiAgXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihcIlRoaXMgYnJvd3NlciBkb2VzIE5PVCBzdXBwb3J0IHRoZSBXZWIgU2VyaWFsIEFQSVwiKTtcclxuICAgICAgfVxyXG4gIFxyXG4gICAgfVxyXG4gIH1cclxuICBcclxuICBjbGFzcyBMaW5lQnJlYWtUcmFuc2Zvcm1lciB7XHJcbiAgICBjb250YWluZXI6IGFueT1cIlwiO1xyXG4gICAgcHJpdmF0ZSBjb250cm9sQ2hhcmFjdGVyOiBzdHJpbmc7XHJcbiAgXHJcbiAgICBjb25zdHJ1Y3Rvcihjb250cm9sQ2hhcmFjdGVyOiBzdHJpbmcpIHtcclxuICAgICAgdGhpcy5jb250YWluZXIgPSAnJztcclxuICAgICAgdGhpcy5jb250cm9sQ2hhcmFjdGVyID0gY29udHJvbENoYXJhY3RlclxyXG4gICAgfVxyXG4gIFxyXG4gICAgdHJhbnNmb3JtKGNodW5rOmFueSwgY29udHJvbGxlcjphbnkpIHtcclxuICAgICAgdGhpcy5jb250YWluZXIgKz0gY2h1bms7XHJcbiAgICAgIGNvbnN0IGxpbmVzID0gdGhpcy5jb250YWluZXIuc3BsaXQodGhpcy5jb250cm9sQ2hhcmFjdGVyKTtcclxuICAgICAgdGhpcy5jb250YWluZXIgPSBsaW5lcy5wb3AoKTtcclxuICAgICAgbGluZXMuZm9yRWFjaCgobGluZTogYW55KSA9PiBjb250cm9sbGVyLmVucXVldWUobGluZSkpO1xyXG4gICAgfVxyXG4gIFxyXG4gICAgZmx1c2goY29udHJvbGxlcjphbnkpIHtcclxuICAgICAgY29udHJvbGxlci5lbnF1ZXVlKHRoaXMuY29udGFpbmVyKTtcclxuICAgIH1cclxuICB9Il19